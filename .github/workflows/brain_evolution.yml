name: Brain Evolution

on:
  schedule:
    # Daily at 00:00 UTC (08:00 Beijing Time)
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  evolve-and-harvest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install requests

      - name: Verify Environment (Debug)
        run: |
          python --version
          pip freeze | grep requests

      - name: Run Harvester & Evolution (The OODA Loop)
        id: harvester
        run: |
          python docs/brain/harvester.py --root docs/brain
          python docs/brain/evolution.py

          # Generate report metadata
          echo "REPORT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "REPORT_PATH=docs/brain/intelligence/REPORT_$(date +'%Y-%m-%d').md" >> $GITHUB_ENV
          echo "BRANCH_NAME=evolution/$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Execute Scholar Morning Routine (Static Contemplation)
        run: python docs/brain/learner.py --root docs/brain

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          commit-message: "Brain Evolution: ${{ env.REPORT_DATE }}"
          title: "Brain Evolution Update - ${{ env.REPORT_DATE }}"
          body: |
            ðŸ§  **Automated Brain Evolution Update**

            - Date: **${{ env.REPORT_DATE }}**
            - Intelligence Report: **${{ env.REPORT_PATH }}**

            This PR was generated automatically by the Brain Evolution workflow.
          labels: |
            evolution
            automated
